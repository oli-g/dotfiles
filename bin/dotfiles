#!/bin/bash

set -euo pipefail

# Setup dotfiles environment variables
DOTFILES_PATH="${HOME}/.dotfiles"
DOTFILES_GIT_REMOTE="git@github.com:oli-g/dotfiles.git"
DOTFILES_GIT_BRANCH="revamp"
DOTFILES_TARBALL_URL="https://github.com/oli-g/dotfiles/tarball/${DOTFILES_GIT_BRANCH}"

# PREZTO_PATH="${HOME}/.zprezto"
# PREZTO_GIT_REMOTE="git@github.com:sorin-ionescu/prezto.git"
# PROJECTS_PATH="${HOME}/Code"

# Download and extract the dotfiles repository, if missing
if [[ ! -d "${DOTFILES_PATH}" ]]; then
    printf "$(tput setaf 7)%s$(tput sgr0)\n" "Downloading dotfiles..."
    curl -fsSLo "${HOME}/dotfiles.tar.gz" "${DOTFILES_TARBALL_URL}"
    mkdir ${DOTFILES_PATH}
    tar -zxf "${HOME}/dotfiles.tar.gz" --strip-components 1 -C "${DOTFILES_PATH}"
    rm -rf "${HOME}/dotfiles.tar.gz"
fi

source "${DOTFILES_PATH}/lib/help.sh"
source "${DOTFILES_PATH}/lib/utils.sh"
source "${DOTFILES_PATH}/lib/brew.sh"

# Display help
if [[ "$#" -eq 0 ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "help" ]] ; then
    run_help
    exit
fi

# Run initialization
if [[ "$1" == "init" ]] ; then
    run_init
    e_success "Dotfiles correctly installed"
    exit
fi

# Run bootstrap
if [[ "$1" == "bootstrap" ]] ; then
    run_bootstrap
    e_success "Dotfiles correctly bootstrapped"
    exit
fi

# Run setup
if [[ "$1" == "setup" ]] ; then
    run_setup
    e_success "Dotfiles correctly set up"
    exit
fi

e_error "Wrong argument: $1"
exit 2
