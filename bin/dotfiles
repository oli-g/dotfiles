#!/bin/bash

DOTFILES_PATH="${HOME}/.dotfiles"
DOTFILES_TARBALL_URL="https://github.com/oli-g/dotfiles/tarball/master"
DOTFILES_GIT_REMOTE="git@github.com:oli-g/dotfiles.git"

PREZTO_PATH="${HOME}/.zprezto"
PREZTO_GIT_REMOTE="git@github.com:sorin-ionescu/prezto.git"

# If missing, download and extract the dotfiles repository
if [[ ! -d $DOTFILES_PATH ]]; then
    printf "$(tput setaf 7)Downloading dotfiles...\033[m\n"
    # mkdir ${DOTFILES_PATH}
    # Get the tarball
    # curl -fsSLo ${HOME}/dotfiles.tar.gz ${DOTFILES_TARBALL_URL}
    # Extract to the dotfiles directory
    # tar -zxf ${HOME}/dotfiles.tar.gz --strip-components 1 -C ${DOTFILES_PATH}
    # Remove the tarball
    # rm -rf ${HOME}/dotfiles.tar.gz
fi

source "${DOTFILES_PATH}/lib/help.sh"
source "${DOTFILES_PATH}/lib/list.sh"
source "${DOTFILES_PATH}/lib/utils.sh"
source "${DOTFILES_PATH}/lib/brew.sh"

# Help text
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    run_help
    exit
fi

# List additional software to install
if [[ "$1" == "-l" || "$1" == "--list" ]]; then
    run_list
    exit
fi

# Test for known flags
for opt in $@; do
    case $opt in
        --no-packages) no_packages=true ;;
        --no-sync) no_sync=true ;;
        -*|--*) e_warning "Warning: invalid option $opt." ;;
    esac
done

# Check that current shell is ZSH
if ! is_zsh_shell; then
    e_error "Zsh must be the default login shell."
    e_advice "Set zsh as default in System Preferences -> User & Groups"
    exit 1
fi

# Before relying on Homebrew, check that packages can be compiled
if ! type_exists "gcc"; then
    e_error "The XCode Command Line Tools must be installed first."
    e_advice "Download them from: https://developer.apple.com/downloads"
    exit 1
fi

source "${DOTFILES_PATH}/lib/brew/install.sh"
source "${DOTFILES_PATH}/lib/zsh/install.sh"
source "${DOTFILES_PATH}/lib/git/install.sh"
source "${DOTFILES_PATH}/lib/sublime/install.sh"
source "${DOTFILES_PATH}/lib/vim/install.sh"
source "${DOTFILES_PATH}/lib/prezto/install.sh"
source "${DOTFILES_PATH}/lib/ruby/install.sh"
source "${DOTFILES_PATH}/lib/go/install.sh"

for file in $(find "${DOTFILES_PATH}/lib" -depth 2 -name *.symlink); do
    # Force create or replace the symlink
    ln -fs $file "${HOME}/.$(basename "${file%.*}")"
done

e_success "Dotfiles installed"